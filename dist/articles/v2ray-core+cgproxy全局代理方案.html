<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" >

<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
      <meta name="dcterms.date" content="2023-06-25" />
        <title>v2ray 结合 cgproxy 全局代理方案</title>
    <link rel="stylesheet" href="/resources/css/article/theme.css" />
    <link rel="stylesheet" href="/resources/css/article/code.css" />
      
  
<style>
@font-face {
  font-family: CONTENT;
  src: url('/resources/fonts/subsets/FTd335a295-647a-4f5e-b15b-140178c18782.woff2') format('woff2'),
       url('/resources/fonts/subsets/FTd335a295-647a-4f5e-b15b-140178c18782.ttf') format('truetype');
}
</style>


  <script src="/resources/js/article.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.3/viewer.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.3/viewer.css" />
</head>

<body>
  <progress id="content_progress" value="0"></progress>
  <button id="back-to-top">
    回页顶
  </button>

  
  <header>
    <h1 class="title">v2ray 结合 cgproxy 全局代理方案</h1>
    <!-- Subtitle -->
        <h3 class="subtitle">&nbsp;</h3>
      </header>

    <nav id="TOC" role="doc-toc">
    <strong>文章归类:&nbsp;<a href="/pages/category.html#备忘录">备忘录</a> </strong>
    <input type="checkbox" id="contents">
    <ul>
    <li><a href="#前提准备" id="toc-前提准备">前提准备</a>
    <ul>
    <li><a href="#确保-cgroup-支持" id="toc-确保-cgroup-支持">确保 cgroup 支持</a></li>
    <li><a href="#v2ray" id="toc-v2ray">v2ray</a></li>
    <li><a href="#配置文件" id="toc-配置文件">配置文件</a></li>
    <li><a href="#安装-cgproxy" id="toc-安装-cgproxy">安装 cgproxy</a></li>
    </ul></li>
    <li><a href="#修改配置文件" id="toc-修改配置文件">修改配置文件</a></li>
    <li><a href="#启用" id="toc-启用">启用</a></li>
    <li><a href="#其他" id="toc-其他">其他</a></li>
    <li><a href="#参考" id="toc-参考">参考</a></li>
    </ul>
    <ul>
      <li><a href="#reference">参考链接</a></li>
      <li>&nbsp;</li>
      <li class="tools">
        <span id="backtomain">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-house"
            viewBox="0 0 16 16">
            <path
              d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5Z" />
          </svg>
        </span>
        <span id="larger">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
              d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
          </svg>
        </span>
        <span id="smaller">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dash-lg"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8Z" />
          </svg>
        </span>
        <span id="switchfont">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-fonts"
            viewBox="0 0 16 16">
            <path
              d="M12.258 3h-8.51l-.083 2.46h.479c.26-1.544.758-1.783 2.693-1.845l.424-.013v7.827c0 .663-.144.82-1.3.923v.52h4.082v-.52c-1.162-.103-1.306-.26-1.306-.923V3.602l.431.013c1.934.062 2.434.301 2.693 1.846h.479L12.258 3z" />
          </svg>
        </span>
        <span id="backtotop">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-bar-up"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
              d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z" />
          </svg>
        </span>
      </li>
    </ul>

  </nav>
  
  <main>
    <p><code>cgproxy</code> 是使用 Linux <code>cgroup</code> 功能实现全局代理的工具。一般在 Linux 上使用代理工具难以设置全局代理，不同的桌面环境，不同的软件行为都不一样，有的读取桌面环境的配置，有的认可环境变量，有的在软件内配置，有的根本不提供代理设置方式。一般对于终端中的程序可以使用 <code>proxychains</code> 来强制走代理，但这个工具是基于 <code>LD_PRELOAD</code>，对于静态链接的程序就不行。所以需要一个统一的解决方案。</p>
    <h2 id="前提准备">前提准备</h2>
    <h3 id="确保-cgroup-支持">确保 cgroup 支持</h3>
    <p>运行 <code>findmnt -t cgroup2</code>，如果出现类似</p>
    <pre class="log"><code>TARGET               SOURCE  FSTYPE  OPTIONS
/sys/fs/cgroup       cgroup2 cgroup2 rw,nosuid,nodev,noexec,relatime
/run/cgproxy/cgroup2 none    cgroup2 rw,relatime</code></pre>
    <p>则支持。</p>
    <h3 id="v2ray">v2ray</h3>
    <p>首先需要安装代理工具核心。可以使用发行版提供的版本，也可以使用安装脚本。<code>v2fly</code> 有提供一个安装脚本。执行即可。</p>
    <div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> <span class="op">&lt;(</span><span class="ex">curl</span> <span class="at">-L</span> https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh<span class="op">)</span></span></code></pre></div>
    <p>当然，访问 <code>githubusercontent</code> 需要代理……所以你可以使用手机共享网络+分享 vpn 的方式。不过似乎中国的大部分 Android 发行版都不支持(?)</p>
    <p>这个脚本将各个文件安装在如下位置：</p>
    <div class="sourceCode" id="cb3"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /usr/local/bin/v2ray</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /usr/local/bin/v2ctl</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /usr/local/share/v2ray/geoip.dat</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /usr/local/share/v2ray/geosite.dat</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /usr/local/etc/v2ray/config.json</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /var/log/v2ray/</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /var/log/v2ray/access.log</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /var/log/v2ray/error.log</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /etc/systemd/system/v2ray.service</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">installed</span><span class="kw">:</span><span class="at"> /etc/systemd/system/v2ray@.service</span></span></code></pre></div>
    <p>值得注意的是配置文件路径：<code>/usr/local/etc/v2ray/config.json</code></p>
    <p>接下来启用和运行 <code>systemd</code> 单元即可：</p>
    <div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable <span class="at">--now</span> v2ray</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl start v2ray</span></code></pre></div>
    <h3 id="配置文件">配置文件</h3>
    <p>当然是你自己搞到配置文件。无论如何，你需要得到一个完整的 json 配置文件来替换 <code>/usr/local/etc/v2ray/config.json</code>，关于如何从订阅链接或者从各种链接转换就不展开说明了。</p>
    <p>其中一个办法是从手机导入，在 v2rayNG 中导出配置到剪贴板再复制到文件，然后复制到电脑上。</p>
    <h3 id="安装-cgproxy">安装 cgproxy</h3>
    <p>首先，你的 Linux 发行版不能太旧。不然都不支持 cgroup v2。</p>
    <p>在编译安装之前需要各种工具和相关的库：</p>
    <ul>
    <li><p><code>cmake</code>, <code>gcc</code>, <code>g++</code> 等编译工具：对于 Debian 系列的发行版，是<code>sudo apt-get install build-essential</code>；对于 openSUSE，是 <code>zypper install -t pattern devel_basis</code>。<code>cmake</code> 可能不在里面，再额外安装一下就行。</p></li>
    <li><p><code>bpftool</code>, <code>libbpf-devel</code>, <code>nlohmann_json-devel</code>：<code>cgproxy</code> 的依赖。对于 openSUSE，软件包就是前面的名字，安装即可。对于其他发行版，请查阅文档。</p></li>
    </ul>
    <p>接下来编译安装：</p>
    <div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/springzfx/cgproxy</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> cgproxy <span class="kw">&amp;&amp;</span> <span class="fu">mkdir</span> build</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> build</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cmake</span> <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release <span class="dt">\</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DCMAKE_INSTALL_PREFIX</span><span class="op">=</span>/usr <span class="dt">\</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">-Dbuild_execsnoop_dl</span><span class="op">=</span>ON <span class="dt">\</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">-Dbuild_static</span><span class="op">=</span>OFF <span class="dt">\</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      ..</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># compile</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
    <p>如果 <code>cmake</code> 报错，就按照错误找缺失的包安装。如果 <code>make</code> 报错，可能是 <code>bpftool</code> 没有安装。</p>
    <p>接下来 <code>sudo make install</code> 安装到系统。并启用 <code>systemd</code> 单元：</p>
    <div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable <span class="at">--now</span> cgproxy.service</span></code></pre></div>
    <p>如果一切顺利，则会提示</p>
    <pre class="log"><code>Created symlink /etc/systemd/system/multi-user.target.wants/cgproxy.service → /usr/lib/systemd/system/cgproxy.service.</code></pre>
    <h2 id="修改配置文件">修改配置文件</h2>
    <p>首先确保你的 <code>v2ray</code> 核心运行良好，请启动它并自行寻找一个方式验证。一般来讲配置的默认入站地址有 <code>socks://127.0.0.1:10808</code>，所以可以在火狐中设置一下代理。总之确保目前的 <code>v2ray</code> 配置无误。</p>
    <p><code>cgproxy</code> 的运行机制可以理解成这样：所有程序网路请求都会被它“拦截”并转发到 <code>v2ray</code>，但转发的协议不是 <code>http</code> 或者 <code>socks</code> 而是 <code>dokodemo-door</code>。所以你需要额外在自己的 <code>v2ray</code> 配置文件里面加入 <code>dokodemo-door</code> 的透明代理监听入站。</p>
    <p>假设原来的配置是这样：</p>
    <div class="sourceCode" id="cb8"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;dns&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="er">...</span><span class="fu">},</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;inbounds&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;listen&quot;</span><span class="fu">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="fu">,</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;port&quot;</span><span class="fu">:</span> <span class="dv">10808</span><span class="fu">,</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;protocol&quot;</span><span class="fu">:</span> <span class="st">&quot;socks&quot;</span><span class="fu">,</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;settings&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="er">...</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;sniffing&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="er">...</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;tag&quot;</span><span class="fu">:</span> <span class="st">&quot;socks&quot;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;listen&quot;</span><span class="fu">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="fu">,</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;port&quot;</span><span class="fu">:</span> <span class="dv">10809</span><span class="fu">,</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;protocol&quot;</span><span class="fu">:</span> <span class="st">&quot;http&quot;</span><span class="fu">,</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;settings&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="er">...</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;tag&quot;</span><span class="fu">:</span> <span class="st">&quot;http&quot;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;log&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;loglevel&quot;</span><span class="fu">:</span> <span class="st">&quot;warning&quot;</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;outbounds&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;routing&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="er">...</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
    <p>可以看见 <code>inbounds</code> 区域里面有两个入站设定，现在把第三个添加到 <code>inbounds</code> 里面：</p>
    <div class="sourceCode" id="cb9"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;tag&quot;</span><span class="fu">:</span> <span class="st">&quot;transparent&quot;</span><span class="fu">,</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;port&quot;</span><span class="fu">:</span> <span class="dv">12345</span><span class="fu">,</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;protocol&quot;</span><span class="fu">:</span> <span class="st">&quot;dokodemo-door&quot;</span><span class="fu">,</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;settings&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;network&quot;</span><span class="fu">:</span> <span class="st">&quot;tcp,udp&quot;</span><span class="fu">,</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;followRedirect&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;sniffing&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;enabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;destOverride&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;http&quot;</span><span class="ot">,</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;tls&quot;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;streamSettings&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;sockopt&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;tproxy&quot;</span><span class="fu">:</span> <span class="st">&quot;tproxy&quot;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
    <p>便于查错，你可以使用 <code>vscode</code> 等工具打开配置文件修改和添加内容。<strong>以防万一，注意备份你的配置</strong>。</p>
    <p>这里设置的 <code>dokodemo-door</code> 监听端口是 <code>12345</code> 端口。修改完毕后保存，然后测试：</p>
    <div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">v2ray</span> test <span class="at">-c</span> /usr/local/etc/v2ray/config.json</span></code></pre></div>
    <p>如果没有问题：</p>
    <pre class="log"><code>V2Ray 5.7.0 (V2Fly, a community-driven edition of V2Ray.) Custom (go1.20.4 linux/amd64)
A unified platform for anti-censorship.
Configuration OK.</code></pre>
    <del>
    那就是没有问题
    </del>
    <p>接下来重启 <code>v2ray</code> 服务：</p>
    <div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart v2ray</span></code></pre></div>
    <p>现在开始修改 <code>cgproxy</code> 的配置文件，其位于 <code>/etc/cgproxy/config.json</code>。</p>
    <p>默认情况下：</p>
    <div class="sourceCode" id="cb13"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;port&quot;</span><span class="fu">:</span> <span class="dv">12345</span><span class="fu">,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;program_noproxy&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;v2ray&quot;</span><span class="ot">,</span> <span class="st">&quot;qv2ray&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;program_proxy&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;cgroup_noproxy&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;/system.slice/v2ray.service&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;cgroup_proxy&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;enable_gateway&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;enable_dns&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;enable_udp&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;enable_tcp&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;enable_ipv4&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;enable_ipv6&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;table&quot;</span><span class="fu">:</span> <span class="dv">10007</span><span class="fu">,</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;fwmark&quot;</span><span class="fu">:</span> <span class="dv">39283</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
    <p>就已经够用。其中 <code>port</code> 就是之前新增的 <code>dokodemo-door</code> 监听端口，而 <code>program_noproxy</code> 是不进行代理的程序名称。<code>v2ray</code> 当然要排除在外，不然就是循环代理了。</p>
    <p>保存配置文件。</p>
    <h2 id="启用">启用</h2>
    <p>确认都配置好了以后，<code>sudo systemctl restart cgproxy.service</code> 启动服务，使用以下命令测试：</p>
    <div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cgproxy</span> curl <span class="at">-vI</span> https://www.google.com</span></code></pre></div>
    <p>注意，先取消之前设置的代理。(清除环境变量，设置等)。如果没有任何问题，就可以稳定运行了。</p>
    <h2 id="其他">其他</h2>
    <p>要查看 <code>v2ray</code> 的日志：</p>
    <div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> journalctl <span class="at">-u</span> v2ray <span class="at">--follow</span> <span class="at">--output</span> cat</span></code></pre></div>
    <p>要停止 <code>cgproxy</code>:</p>
    <div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl disable <span class="at">--now</span> cgproxy.service</span></code></pre></div>
    <p><strong>注意</strong>：<strong>必须</strong>使用 <code>sudo systemctl disable --now cgproxy.service</code> 来关闭服务，否则下一次启动可能会失效！</p>
    <h2 id="参考">参考</h2>
    <ul>
    <li><a href="https://github.com/v2fly/v2ray-core">v2fly/v2ray-core</a></li>
    <li><a href="https://github.com/springzfx/cgproxy">springzfx/cgproxy</a></li>
    <li><a href="https://docs.kernel.org/admin-guide/cgroup-v2.html">Control Group v2</a></li>
    </ul>

    <br />
    <!--%%REF%%-->


    <br />
    <script src="https://giscus.app/client.js" data-repo="izfsk-ium/izfsk-ium.github.io" data-repo-id="R_kgDOJ7Ymyw"
      data-category="Announcements" data-category-id="DIC_kwDOJ7Ymy84CX4eg" data-mapping="title" data-strict="0"
      data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme"
      data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async>
      </script>
  </main>



  <footer>
    <p class="signoff">
    <div class="metadata">
            <p class="date"><time datetime="2023-06-25">创建日期：2023-06-25</time></p>
            <p class="lastmodify"><time>最后编译：2023-07-14</time></p>
    </div>
    </p>
  </footer>

  
  <style>
    #back-to-top {
      position: fixed;
      bottom: 25px;
      right: 20px;
      display: none;
      border-radius: 0;
      padding: 3px;
      background: var(--background-color);
      border-color: gray;
      z-index: 999;
      color: var(--color-text);
    }
  </style>
  <script>
    window.addEventListener('scroll', function () {
      var button = document.getElementById('back-to-top');
      if (window.pageYOffset > 125) {
        button.style.display = 'block';
      } else {
        button.style.display = 'none';
      }
    });

    document.getElementById('back-to-top').addEventListener('click', function () {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>

</html>